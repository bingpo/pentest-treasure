## 推荐学习：

[构造优质上传漏洞FUZZ字典](https://gv7.me/articles/2018/make-upload-vul-fuzz-dic/)

[文件上传总结](https://www.1024sou.com/article/798418.html)


### 类型校验

-   Content-Type校验

-   前端验证后缀

### Server解析

-   后缀名大小写

-   可上传.htaccess配置解析`AddType  application/x-httpd-php    .jpg`

-   可解析其他后缀(取决于中间件配置)

    **".phar"**,".php",".php5",".php4",".php3",".php2","php1",".html",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2","pHp1",".Html",".Htm",".pHtml"等等

-   [Apache解析规则：从右往左直到能解析成功](https://www.cnblogs.com/natian-ws/p/7265806.html)

-   [中间件解析漏洞](https://www.cnblogs.com/1996-11-01-614lb/p/14237744.html)

### 系统特性

-   Windows：
    -   windows系统特性：后缀名最后一个空格和`.`会被去掉(所以可以尝试所有点和空格的组合，点空格点，空格点，点空格，空格点空格)
    -   windows系统特性：`::$DATA`
-   Linux：
    -   Linux是根据文件文件头和文件内容判断文件类型，故只要文件中含有文件头，不管4字节和8字节均会被系统认为是图片文件（完事儿访问需要IE/Edge访问，谷歌火狐不行）

### 函数特性

-   [move_uploaded_file第二个参数00截断](https://www.cnblogs.com/cyjaysun/p/4390930.html) 高版本php（5.4.x<= 5.4.39, 5.5.x<= 5.5.23, 5.6.x <= 5.6.7）

### 技巧

-   [垃圾字符后缀绕过的一个例子，以及使用Content-Encoding内容绕过的例子](https://www.t00ls.com/viewthread.php?tid=68600)
-   双写后缀名（比如代码中有str_replace只处理一次，替换为空的情况）
-   00截断可控的文件保存路径，如`$img_path = $_GET['save_path']."/".rand(10, 99).date("YmdHis").".".$file_ext`
-   图片马：copy 1.jpg/b + 1.php/a 2.jpg 
-   [绕过二次渲染](https://xz.aliyun.com/t/2657)
-   条件竞争
-   有源码的情况下，根据具体判断逻辑，构造参数，绕过。例如：利用数组绕过。（Upload_labs Pass-21 ）

```php
$file = empty($_POST['save_name']) ? $_FILES['upload_file']['name'] : $_POST['save_name'];
if (!is_array($file)) {
    $file = explode('.', strtolower($file));
}

$ext = end($file);
$allow_suffix = array('jpg','png','gif');
if (!in_array($ext, $allow_suffix)) {
    $msg = "禁止上传该后缀文件!";
}else{
    $file_name = reset($file) . '.' . $file[count($file) - 1];
    var_dump($file);
    echo $file_name;
    echo "=======";
    $temp_file = $_FILES['upload_file']['tmp_name'];
    $img_path = UPLOAD_PATH . '/' .$file_name;
    echo $img_path;
    if (move_uploaded_file($temp_file, $img_path)) {
        $msg = "文件上传成功！";
        $is_upload = true;
    } else {
        $msg = "文件上传失败！";
    }
}
```


